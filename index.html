<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comune di Piacenza Roleplay - Login</title>
    <link rel="stylesheet" href="login.css">
</head>
<body>
    <div class="container">
        <div class="login-box">
            <div class="header">
                <h1>Benvenuto da</h1>
                <h2>Comune di Piacenza Roleplay</h2>
                <div class="logo-placeholder">
                    <img id="logo" src="logo.png" alt="Logo Comune di Piacenza" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="logo-text" style="display: none;">LOGO</div>
                </div>
            </div>

            <div class="links-container">
                <a href="https://discord.gg/tuoserver" target="_blank" class="link-btn discord">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418z"/>
                    </svg>
                    Server Discord
                </a>
                <a href="https://www.roblox.com/groups/tuogruppo" target="_blank" class="link-btn roblox">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18.926 23.998L0.002 18.521 5.075 0.002l18.924 5.477-5.073 18.519zM9.233 13.499l3.722 1.077 1.077-3.721-3.722-1.078-1.077 3.722z"/>
                    </svg>
                    Server Roblox
                </a>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showTab('login')">Login</button>
                <button class="tab" onclick="showTab('register')">Registrazione</button>
                <button class="tab" onclick="showTab('admin')">Amministratore</button>
                <button class="tab" onclick="showTab('institutional')">Esponente Istituzionale</button>
            </div>

            <form id="loginForm" class="form-container active">
                <div class="input-group">
                    <label for="loginUsername">Nome Utente</label>
                    <input type="text" id="loginUsername" required>
                </div>
                <div class="input-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="submit-btn">Accedi</button>
            </form>

            <form id="registerForm" class="form-container">
                <div class="input-group">
                    <label for="regUsername">Nome Utente</label>
                    <input type="text" id="regUsername" required>
                </div>
                <div class="input-group">
                    <label for="regEmail">Email</label>
                    <input type="email" id="regEmail" required>
                </div>
                <div class="input-group">
                    <label for="regPassword">Password</label>
                    <input type="password" id="regPassword" required>
                </div>
                <div class="input-group">
                    <label for="regPasswordConfirm">Conferma Password</label>
                    <input type="password" id="regPasswordConfirm" required>
                </div>
                <button type="submit" class="submit-btn">Registrati</button>
            </form>

            <form id="adminForm" class="form-container">
                <div class="input-group">
                    <label for="adminUsername">Nome Utente</label>
                    <input type="text" id="adminUsername" required>
                </div>
                <div class="input-group">
                    <label for="adminEmail">Email Amministratore</label>
                    <input type="email" id="adminEmail" placeholder="admin@piacenzarp.it" required>
                </div>
                <div class="input-group">
                    <label for="adminPassword">Password</label>
                    <input type="password" id="adminPassword" required>
                </div>
                <button type="submit" class="submit-btn admin-btn">Accedi come Admin</button>
            </form>

            <form id="institutionalForm" class="form-container">
                <div class="input-group">
                    <label for="instEmail">Email</label>
                    <input type="email" id="instEmail" placeholder="tua@email.com" required>
                </div>
                <div class="input-group">
                    <label for="instFaction">Fazione</label>
                    <select id="instFaction" required>
                        <option value="">Seleziona la tua fazione</option>
                        <option value="Polizia di Stato">üëÆ Polizia di Stato</option>
                        <option value="Arma dei Carabinieri">üéñÔ∏è Arma dei Carabinieri</option>
                        <option value="Polizia Locale">üöì Polizia Locale</option>
                        <option value="Guardia di Finanza">üí∞ Guardia di Finanza</option>
                        <option value="Polizia Penitenziaria">üîí Polizia Penitenziaria</option>
                        <option value="Vigili del Fuoco">üöí Vigili del Fuoco</option>
                        <option value="Croce Rossa Italiana">üè• Croce Rossa Italiana</option>
                        <option value="Croce Verde">üíö Croce Verde</option>
                        <option value="ACI">üöó ACI (Automobile Club)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="instID">ID Esponente</label>
                    <input type="text" id="instID" placeholder="Es: PS001" required>
                </div>
                <div class="input-group">
                    <label for="instPassword">Password</label>
                    <input type="password" id="instPassword" required>
                </div>
                <button type="submit" class="submit-btn institutional-btn">Accedi come Esponente</button>
            </form>
        </div>
    </div>
        </div>
    </div>

    <div id="authModal" class="modal">
        <div class="modal-content">
            <h3>Codice di Autenticazione</h3>
            <p>Inserisci il codice a 6 cifre inviato alla tua email</p>
            <form id="authForm">
                <div class="input-group">
                    <input type="text" id="authCode" maxlength="6" placeholder="000000" required>
                </div>
                <button type="submit" class="submit-btn">Verifica</button>
                <button type="button" class="cancel-btn" onclick="closeAuthModal()">Annulla</button>
            </form>
        </div>
    </div>

    <script>
    // SISTEMA AUTENTICAZIONE INCORPORATO
    let generatedCode = '';
    let pendingUser = null;

    // Redirect se loggato
    if (sessionStorage.getItem('logged') === 'yes') {
        window.location.href = 'home.html';
    }

    function makeCode() {
        return String(Math.floor(100000 + Math.random() * 900000));
    }

    function showTab(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.form-container').forEach(f => f.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(tab + 'Form').classList.add('active');
    }

    // LOGIN
    document.getElementById('loginForm').onsubmit = function(e) {
        e.preventDefault();
        
        let user = document.getElementById('loginUsername').value.trim();
        let pass = document.getElementById('loginPassword').value.trim();
        
        console.log('üîç Tentativo login:', user);
        
        let saved = localStorage.getItem('piacenzaUsers');
        
        if (!saved) {
            alert('‚ùå NESSUN UTENTE REGISTRATO!\n\nDevi prima REGISTRARTI.');
            console.log('‚ùå localStorage vuoto');
            return;
        }
        
        let users = JSON.parse(saved);
        console.log('üë• Utenti trovati:', users);
        
        let found = users.find(u => u.username === user && u.password === pass);
        
        if (!found) {
            alert('‚ùå CREDENZIALI ERRATE!\n\nUsername o password sbagliati.');
            console.log('‚ùå Utente non trovato');
            return;
        }
        
        console.log('‚úÖ Utente trovato!');
        generatedCode = makeCode();
        pendingUser = {username: found.username, email: found.email, admin: false};
        
        console.log('üîë CODICE:', generatedCode);
        alert('üìß CODICE INVIATO!\n\n' + generatedCode + '\n\n(Inseriscilo nel modal)');
        
        document.getElementById('authModal').style.display = 'flex';
    };

    // REGISTRAZIONE
    document.getElementById('registerForm').onsubmit = function(e) {
        e.preventDefault();
        
        let user = document.getElementById('regUsername').value.trim();
        let email = document.getElementById('regEmail').value.trim();
        let pass = document.getElementById('regPassword').value.trim();
        let conf = document.getElementById('regPasswordConfirm').value.trim();
        
        console.log('üìù Registrazione:', user);
        
        if (pass !== conf) {
            alert('‚ùå Le password non coincidono!');
            return;
        }
        
        if (pass.length < 6) {
            alert('‚ùå Password troppo corta! Minimo 6 caratteri.');
            return;
        }
        
        let saved = localStorage.getItem('piacenzaUsers');
        let users = saved ? JSON.parse(saved) : [];
        
        if (users.find(u => u.username === user)) {
            alert('‚ùå UTENTE GI√Ä ESISTENTE!');
            return;
        }
        
        generatedCode = makeCode();
        pendingUser = {username: user, email: email, password: pass, admin: false, register: true};
        
        console.log('üîë CODICE:', generatedCode);
        alert('üìß CODICE INVIATO!\n\n' + generatedCode + '\n\n(Inseriscilo nel modal)');
        
        document.getElementById('authModal').style.display = 'flex';
    };

    // ADMIN
    document.getElementById('adminForm').onsubmit = function(e) {
        e.preventDefault();
        
        let user = document.getElementById('adminUsername').value.trim();
        let email = document.getElementById('adminEmail').value.trim();
        let pass = document.getElementById('adminPassword').value.trim();
        
        if (email !== 'admin@piacenzarp.it' || pass !== 'admin123') {
            alert('‚ùå CREDENZIALI ADMIN ERRATE!');
            return;
        }
        
        generatedCode = makeCode();
        pendingUser = {username: user, email: email, admin: true, institutional: false};
        
        console.log('üîë CODICE:', generatedCode);
        alert('üìß CODICE ADMIN!\n\n' + generatedCode);
        
        document.getElementById('authModal').style.display = 'flex';
    };

    // ESPONENTE ISTITUZIONALE
    document.getElementById('institutionalForm').onsubmit = function(e) {
        e.preventDefault();
        
        let email = document.getElementById('instEmail').value;
        let id = document.getElementById('instID').value.trim();
        let pass = document.getElementById('instPassword').value.trim();
        
        if (!email) {
            alert('‚ùå Seleziona una fazione!');
            return;
        }
        
        // Password default per test: "istituzionale123"
        if (pass !== 'istituzionale123') {
            alert('‚ùå PASSWORD ERRATA!\n\nPassword default: istituzionale123');
            return;
        }
        
        // Mappa email -> fazione
        const factionMap = {
            'poliziadistato@piacenzarp.it': 'Polizia di Stato',
            'carabinieri@piacenzarp.it': 'Arma dei Carabinieri',
            'polizialocale@piacenzarp.it': 'Polizia Locale',
            'guardiadifinanza@piacenzarp.it': 'Guardia di Finanza',
            'poliziapenitenziaria@piacenzarp.it': 'Polizia Penitenziaria',
            'vigilidelfuoco@piacenzarp.it': 'Vigili del Fuoco',
            'crocerossaitaliana@piacenzarp.it': 'Croce Rossa Italiana',
            'croceverde@piacenzarp.it': 'Croce Verde',
            'aci@piacenzarp.it': 'ACI'
        };
        
        const factionName = factionMap[email];
        
        generatedCode = makeCode();
        pendingUser = {
            username: id,
            email: email,
            admin: false,
            institutional: true,
            faction: factionName
        };
        
        console.log('üîë CODICE ISTITUZIONALE:', generatedCode);
        alert('üìß CODICE ESPONENTE!\n\nFazione: ' + factionName + '\n\n' + generatedCode);
        
        document.getElementById('authModal').style.display = 'flex';
    };

    // VERIFICA CODICE
    document.getElementById('authForm').onsubmit = function(e) {
        e.preventDefault();
        
        let code = document.getElementById('authCode').value.trim();
        
        console.log('üîç Verifica:', code, '===', generatedCode);
        
        if (code !== generatedCode) {
            alert('‚ùå CODICE ERRATO!\n\nCorretto: ' + generatedCode);
            return;
        }
        
        console.log('‚úÖ Codice corretto!');
        
        if (pendingUser.register) {
            let saved = localStorage.getItem('piacenzaUsers');
            let users = saved ? JSON.parse(saved) : [];
            users.push({username: pendingUser.username, email: pendingUser.email, password: pendingUser.password});
            localStorage.setItem('piacenzaUsers', JSON.stringify(users));
            console.log('üíæ Utente salvato');
        }
        
        sessionStorage.setItem('logged', 'yes');
        sessionStorage.setItem('currentUser', JSON.stringify({
            username: pendingUser.username,
            email: pendingUser.email,
            isAdmin: pendingUser.admin,
            isInstitutional: pendingUser.institutional || false,
            faction: pendingUser.faction || null
        }));
        
        alert('‚úÖ ACCESSO EFFETTUATO!');
        window.location.href = 'home.html';
    };

    function closeAuthModal() {
        document.getElementById('authModal').style.display = 'none';
        document.getElementById('authCode').value = '';
    }

    document.getElementById('authCode').oninput = function() {
        this.value = this.value.replace(/[^0-9]/g, '');
    };

    console.log('‚úÖ SISTEMA CARICATO!');
    console.log('üíæ Utenti nel localStorage:', localStorage.getItem('piacenzaUsers'));
    </script>
</body>
</html>