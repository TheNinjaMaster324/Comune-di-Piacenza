<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comune di Piacenza Roleplay - Login</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; padding: 20px; }
        .container { width: 100%; max-width: 500px; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .login-box { background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); padding: 40px; overflow: hidden; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 28px; color: #333; margin-bottom: 5px; }
        .header h2 { font-size: 24px; color: #667eea; font-weight: 600; margin-bottom: 20px; }
        .logo-placeholder { width: 120px; height: 120px; margin: 0 auto 20px; }
        .logo-placeholder img { width: 100%; height: 100%; object-fit: contain; border-radius: 15px; }
        .logo-text { width: 120px; height: 120px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
        .links-container { display: flex; gap: 10px; margin-bottom: 25px; }
        .link-btn { flex: 1; padding: 12px 15px; border-radius: 10px; text-decoration: none; color: white; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s ease; font-size: 14px; }
        .link-btn.discord { background: #5865F2; }
        .link-btn.discord:hover { background: #4752C4; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(88, 101, 242, 0.4); }
        .link-btn.roblox { background: #E74C3C; }
        .link-btn.roblox:hover { background: #C0392B; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4); }
        .tabs { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 25px; background: #f5f5f5; padding: 5px; border-radius: 10px; }
        .tab { padding: 12px 10px; border: none; background: transparent; color: #666; font-weight: 600; cursor: pointer; border-radius: 8px; transition: all 0.3s ease; font-size: 13px; text-align: center; }
        .tab.active { background: white; color: #667eea; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
        .tab:hover:not(.active) { color: #333; }
        .form-container { display: none; animation: slideIn 0.3s ease; }
        .form-container.active { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 14px; }
        .input-group input, .input-group select { width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 15px; transition: all 0.3s ease; font-family: inherit; }
        .input-group input:focus, .input-group select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .submit-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-top: 10px; }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); }
        .admin-btn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .admin-btn:hover { box-shadow: 0 8px 20px rgba(245, 87, 108, 0.4); }
        .institutional-btn { background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); }
        .institutional-btn:hover { box-shadow: 0 8px 20px rgba(255, 215, 0, 0.4); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); align-items: center; justify-content: center; animation: fadeIn 0.3s ease; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 40px; border-radius: 20px; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
        .modal-content h3 { color: #333; margin-bottom: 10px; font-size: 24px; }
        .modal-content p { color: #666; margin-bottom: 20px; font-size: 14px; }
        .modal-content input { text-align: center; font-size: 24px; letter-spacing: 8px; font-weight: 600; }
        .cancel-btn { width: 100%; padding: 12px; background: #e0e0e0; color: #666; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-top: 10px; }
        .cancel-btn:hover { background: #d0d0d0; }
        .cookie-consent { background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ffc107; }
        .cookie-consent label { display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 14px; color: #856404; }
        .cookie-consent input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
        .loading { display: none; text-align: center; margin: 20px 0; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 768px) { .login-box { padding: 30px 25px; } .header h1 { font-size: 24px; } .header h2 { font-size: 20px; } .tabs { grid-template-columns: 1fr 1fr; gap: 6px; } .tab { font-size: 12px; padding: 10px 5px; } }
        @media (max-width: 480px) { body { padding: 10px; } .login-box { padding: 25px 20px; } .tabs { grid-template-columns: 1fr; } .tab { font-size: 14px; padding: 12px; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="login-box">
            <div class="header">
                <h1>Benvenuto da</h1>
                <h2>Comune di Piacenza Roleplay</h2>
                <div class="logo-placeholder">
                    <img src="../Comune-di-Piacenza/Piace.jfif" alt="Logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="logo-text" style="display: none;">LOGO</div>
                </div>
            </div>

            <div class="links-container">
                <a href="https://discord.gg/tuoserver" target="_blank" class="link-btn discord">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418z"/></svg>
                    Server Discord
                </a>
                <a href="https://www.roblox.com/groups/tuogruppo" target="_blank" class="link-btn roblox">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M18.926 23.998L0.002 18.521 5.075 0.002l18.924 5.477-5.073 18.519zM9.233 13.499l3.722 1.077 1.077-3.721-3.722-1.078-1.077 3.722z"/></svg>
                    Server Roblox
                </a>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showTab('login')">Login</button>
                <button class="tab" onclick="showTab('register')">Registrazione</button>
                <button class="tab" onclick="showTab('admin')">Admin</button>
                <button class="tab" onclick="showTab('institutional')">Esponente</button>
            </div>

            <form id="loginForm" class="form-container active">
                <div class="input-group">
                    <label for="loginUsername">Nome Utente</label>
                    <input type="text" id="loginUsername" required>
                </div>
                <div class="input-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="submit-btn">Accedi</button>
            </form>

            <form id="registerForm" class="form-container">
                <div class="input-group">
                    <label for="regUsername">Nome Utente</label>
                    <input type="text" id="regUsername" required>
                </div>
                <div class="input-group">
                    <label for="regEmail">Email</label>
                    <input type="email" id="regEmail" required>
                </div>
                <div class="input-group">
                    <label for="regPassword">Password</label>
                    <input type="password" id="regPassword" required>
                </div>
                <div class="input-group">
                    <label for="regPasswordConfirm">Conferma Password</label>
                    <input type="password" id="regPasswordConfirm" required>
                </div>
                <button type="submit" class="submit-btn">Registrati</button>
            </form>

            <form id="adminForm" class="form-container">
                <div class="input-group">
                    <label for="adminUsername">Nome Utente</label>
                    <input type="text" id="adminUsername" required>
                </div>
                <div class="input-group">
                    <label for="adminEmail">Email Admin</label>
                    <input type="email" id="adminEmail" placeholder="Esempio: admin@email.com" required>
                </div>
                <div class="input-group">
                    <label for="adminPassword">Password</label>
                    <input type="password" id="adminPassword" required>
                </div>
                <button type="submit" class="submit-btn admin-btn">Accedi come Admin</button>
            </form>

            <form id="institutionalForm" class="form-container">
                <div class="input-group">
                    <label for="instEmail">Email</label>
                    <input type="email" id="instEmail" required>
                </div>
                <div class="input-group">
                    <label for="instFaction">Fazione</label>
                    <select id="instFaction" required>
                        <option value="">Seleziona fazione</option>
                        <option value="Polizia di Stato">üëÆ Polizia di Stato</option>
                        <option value="Arma dei Carabinieri">üéñÔ∏è Carabinieri</option>
                        <option value="Polizia Locale">üöì Polizia Locale</option>
                        <option value="Guardia di Finanza">üí∞ Guardia di Finanza</option>
                        <option value="Polizia Penitenziaria">üîí Polizia Penitenziaria</option>
                        <option value="Vigili del Fuoco">üöí Vigili del Fuoco</option>
                        <option value="Croce Rossa Italiana">üè• Croce Rossa</option>
                        <option value="Croce Verde">üíö Croce Verde</option>
                        <option value="ACI">üöó ACI</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="instID">ID Esponente</label>
                    <input type="text" id="instID" placeholder="Es: PS001" required>
                </div>
                <div class="input-group">
                    <label for="instPassword">Password</label>
                    <input type="password" id="instPassword" required>
                </div>
                <button type="submit" class="submit-btn institutional-btn">Accedi come Esponente</button>
            </form>

            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <p style="margin-top: 15px; color: #667eea; font-weight: 600;">üìß Invio email in corso...</p>
            </div>
        </div>
    </div>

    <div id="authModal" class="modal">
        <div class="modal-content">
            <h3>Codice di Autenticazione</h3>
            <p id="modalMessage">Controlla la tua email e inserisci il codice a 6 cifre</p>
            
            <div class="cookie-consent" id="cookieConsent" style="display: none;">
                <label>
                    <input type="checkbox" id="acceptCookies">
                    <span>Ricordami per 5 giorni</span>
                </label>
            </div>
            
            <form id="authForm">
                <div class="input-group">
                    <input type="text" id="authCode" maxlength="6" placeholder="000000" required>
                </div>
                <button type="submit" class="submit-btn">Verifica</button>
                <button type="button" class="cancel-btn" onclick="closeAuthModal()">Annulla</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        emailjs.init("ztN0HeQf-_ojjp-7W");
        let generatedCode = '';
        let pendingUser = null;
        const TEMPLATE_ID = "template_0jkzo2a"; // ‚ö†Ô∏è SOSTITUISCI

        window.addEventListener('load', function() {
            const savedLogin = localStorage.getItem('piacenza_auto_login');
            if (savedLogin) {
                const { userData, expiry } = JSON.parse(savedLogin);
                if (new Date().getTime() < expiry) {
                    completeLogin(userData, false);
                    return;
                } else {
                    localStorage.removeItem('piacenza_auto_login');
                }
            }
            if (sessionStorage.getItem('logged') === 'yes') window.location.href = 'home.html';
        });

        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.form-container').forEach(f => f.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + 'Form').classList.add('active');
        }

        function makeCode() { return String(Math.floor(100000 + Math.random() * 900000)); }

     async function sendEmail(email, code, type) {
    document.getElementById('loading').style.display = 'block';
    
    // Se TEMPLATE_ID non √® configurato, usa alert
    if (TEMPLATE_ID === "Piacenza" || !TEMPLATE_ID) {z
        document.getElementById('loading').style.display = 'none';
        alert(`üìß CODICE DI AUTENTICAZIONE\n\nEmail: ${email}\nTipo: ${type}\n\nüîë CODICE: ${code}\n\nInserisci questo codice nel modal.\n\n(Configura TEMPLATE_ID per email vera)`);
        return true;
    }
    
    try {
        const response = await emailjs.send("service_nc6elei", TEMPLATE_ID, {
            to_email: email,
            to_name: email.split('@')[0],
            code: code,
            type: type
        });
        
        console.log('‚úÖ Email inviata:', response);
        document.getElementById('loading').style.display = 'none';
        alert('üìß Codice inviato via email!\n\nControlla la tua casella (anche spam).');
        return true;
    } catch (error) {
        console.error('‚ùå Errore EmailJS:', error);
        document.getElementById('loading').style.display = 'none';
        alert(`‚ùå Errore invio email!\n\nüîë CODICE: ${code}\n\n(Usa questo codice per continuare)`);
        return true;
    }
}

        document.getElementById('loginForm').onsubmit = async function(e) {
            e.preventDefault();
            const user = document.getElementById('loginUsername').value.trim();
            const pass = document.getElementById('loginPassword').value.trim();
            const users = JSON.parse(localStorage.getItem('piacenzaUsers') || '[]');
            const found = users.find(u => u.username === user && u.password === pass);
            if (!found) { alert('‚ùå CREDENZIALI ERRATE!'); return; }
            generatedCode = makeCode();
            pendingUser = {username: found.username, email: found.email, isAdmin: false, isInstitutional: false};
            await sendEmail(found.email, generatedCode, 'Login');
            document.getElementById('cookieConsent').style.display = 'block';
            document.getElementById('authModal').style.display = 'flex';
        };

        document.getElementById('registerForm').onsubmit = async function(e) {
            e.preventDefault();
            const user = document.getElementById('regUsername').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const pass = document.getElementById('regPassword').value.trim();
            const conf = document.getElementById('regPasswordConfirm').value.trim();
            if (pass !== conf) { alert('‚ùå Le password non coincidono!'); return; }
            if (pass.length < 6) { alert('‚ùå Password troppo corta!'); return; }
            const users = JSON.parse(localStorage.getItem('piacenzaUsers') || '[]');
            if (users.find(u => u.username === user)) { alert('‚ùå Username gi√† esistente!'); return; }
            generatedCode = makeCode();
            pendingUser = {username: user, email: email, password: pass, isAdmin: false, isInstitutional: false, register: true};
            await sendEmail(email, generatedCode, 'Registrazione');
            document.getElementById('cookieConsent').style.display = 'block';
            document.getElementById('authModal').style.display = 'flex';
        };

        document.getElementById('adminForm').onsubmit = async function(e) {
            e.preventDefault();
            const user = document.getElementById('adminUsername').value.trim();
            const email = document.getElementById('adminEmail').value.trim();
            const pass = document.getElementById('adminPassword').value.trim();
            if (email !== 'amministrazionepiacenzarp@gmail.com' || pass !== 'amministrazionePiacenzaRP2.0') { alert('‚ùå CREDENZIALI ADMIN ERRATE!'); return; }
            generatedCode = makeCode();
            pendingUser = {username: user, email: email, isAdmin: true, isInstitutional: false};
            await sendEmail(email, generatedCode, 'Login Admin');
            document.getElementById('cookieConsent').style.display = 'block';
            document.getElementById('authModal').style.display = 'flex';
        };

        document.getElementById('institutionalForm').onsubmit = async function(e) {
            e.preventDefault();
            const email = document.getElementById('instEmail').value.trim();
            const faction = document.getElementById('instFaction').value;
            const id = document.getElementById('instID').value.trim();
            const pass = document.getElementById('instPassword').value.trim();
            if (!faction) { alert('‚ùå Seleziona una fazione!'); return; }
            if (pass !== 'istituzionale123') { alert('‚ùå PASSWORD ERRATA!\n\nPassword: istituzionale123'); return; }
            generatedCode = makeCode();
            pendingUser = {username: id, email: email, isAdmin: false, isInstitutional: true, faction: faction};
            await sendEmail(email, generatedCode, 'Login Esponente - ' + faction);
            document.getElementById('cookieConsent').style.display = 'block';
            document.getElementById('authModal').style.display = 'flex';
        };

        document.getElementById('authForm').onsubmit = function(e) {
            e.preventDefault();
            const code = document.getElementById('authCode').value.trim();
            if (code !== generatedCode) { alert('‚ùå CODICE ERRATO!'); return; }
            if (pendingUser.register) {
                const users = JSON.parse(localStorage.getItem('piacenzaUsers') || '[]');
                users.push({username: pendingUser.username, email: pendingUser.email, password: pendingUser.password});
                localStorage.setItem('piacenzaUsers', JSON.stringify(users));
            }
            const acceptCookies = document.getElementById('acceptCookies').checked;
            completeLogin(pendingUser, acceptCookies);
        };

        function completeLogin(user, saveCookie) {
            sessionStorage.setItem('logged', 'yes');
            sessionStorage.setItem('currentUser', JSON.stringify(user));
            if (saveCookie) {
                const expiry = new Date().getTime() + (5 * 24 * 60 * 60 * 1000);
                localStorage.setItem('piacenza_auto_login', JSON.stringify({userData: user, expiry: expiry}));
            }
            alert('‚úÖ ACCESSO EFFETTUATO!');
            window.location.href = 'home.html';
        }

        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
            document.getElementById('authCode').value = '';
            document.getElementById('acceptCookies').checked = false;
        }

        document.getElementById('authCode').oninput = function() {
            this.value = this.value.replace(/[^0-9]/g, '');
        };
    </script>
</body>
</html>